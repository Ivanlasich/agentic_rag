"""
FastAPI Streaming API –¥–ª—è GraphRAG MCP Agent

–°–µ—Ä–≤–µ—Ä —Å Server-Sent Events –¥–ª—è streaming –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç GraphRAG MCP –∞–≥–µ–Ω—Ç–∞.
"""

import asyncio
import json
import time
import os
import glob
from pathlib import Path
from fastapi import FastAPI
from fastapi.responses import StreamingResponse
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from mcp_use import MCPAgent, MCPClient

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏ (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º–æ —á–µ—Ä–µ–∑ ENV)
os.environ.setdefault("OPENAI_BASE_URL", os.getenv("OPENAI_BASE_URL", "http://172.17.0.1:19000/v1"))
os.environ.setdefault("OPENAI_API_KEY", os.getenv("OPENAI_API_KEY", "dummy-key"))

# URL MCP —Å–µ—Ä–≤–µ—Ä–∞ Qdrant (–≤ Docker —Å–µ—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Å–µ—Ä–≤–∏—Å–∞)
MCP_QDRANT_SSE_URL = os.getenv("MCP_QDRANT_SSE_URL", "http://mcp-qdrant-domains:8000/sse")

app = FastAPI(
    title="Qdrant Domains MCP Streaming API",
    description="API –¥–ª—è streaming –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç Qdrant Domains MCP –∞–≥–µ–Ω—Ç–∞ —Å –º–æ–¥–µ–ª—å—é Qwen3-Coder",
    version="1.0.0"
)

# –î–æ–±–∞–≤–ª—è–µ–º CORS middleware –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≥–µ–Ω—Ç–∞
_agent_cache = None

# –ü—É—Ç–∏ –∫ –ø–∞–ø–∫–∞–º —Å –¥–æ–º–µ–Ω–∞–º–∏ (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º–æ —á–µ—Ä–µ–∑ ENV)
UPLOADS_PATH = os.getenv("UPLOADS_PATH", "/app/uploads")
SUMMARY_PATH = os.getenv("SUMMARY_PATH", "/app/domains_summary")

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–∫–∞–∫ –≤ indexing_api.py)
os.makedirs(UPLOADS_PATH, exist_ok=True)
os.makedirs(SUMMARY_PATH, exist_ok=True)

def load_available_domains():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ –∏–∑ –ø–∞–ø–∫–∏ uploads"""
    domains = []
    uploads_dir = Path(UPLOADS_PATH)
    
    if uploads_dir.exists():
        for domain_dir in uploads_dir.iterdir():
            if domain_dir.is_dir():
                domains.append(domain_dir.name)
    return sorted(["tech_instruction", "client_interface","hr", "user_info"])
    return sorted(domains)

def load_domain_summary(domain_name: str) -> str:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç summary –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞"""
    summary_file = Path(SUMMARY_PATH) / f"{domain_name}_summary.txt"
    
    if summary_file.exists():
        try:
            with open(summary_file, 'r', encoding='utf-8') as f:
                return f.read().strip()
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è summary –¥–ª—è –¥–æ–º–µ–Ω–∞ {domain_name}: {e}")
            return ""
    else:
        print(f"‚ö†Ô∏è Summary —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –¥–æ–º–µ–Ω–∞ {domain_name}: {summary_file}")
        return ""

def load_all_domain_summaries():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ summary –¥–æ–º–µ–Ω–æ–≤"""
    domains = load_available_domains()
    summaries = {}
    
    for domain in domains:
        summary = load_domain_summary(domain)
        if summary:
            summaries[domain] = summary
    
    return summaries

def build_domains_context():
    """–°—Ç—Ä–æ–∏—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–º–µ–Ω–∞—Ö –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞"""
    domains = load_available_domains()
    summaries = load_all_domain_summaries()
    
    if not domains:
        return "\n## –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ–º–µ–Ω—ã:\n–î–æ–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É uploads.\n\n"
    
    context = "\n## –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ–º–µ–Ω—ã –∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–µ:\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –¥–æ–º–µ–Ω–µ
    for domain in domains:
        context += f"### –î–æ–º–µ–Ω: {domain}\n"
        
        if domain in summaries and summaries[domain]:
            context += f"{summaries[domain]}\n\n"
        else:
            context += f"–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–º–µ–Ω–∞ '{domain}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ summary —Ñ–∞–π–ª–∞—Ö.\n\n"
    
    # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
    context += "## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –¥–æ–º–µ–Ω–æ–≤:\n"
    context += "- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä `collection_name` –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞\n"
    context += f"- –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ–º–µ–Ω—ã: {', '.join(domains)}\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–º–µ–Ω–∞
    context += "- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤:\n"
    for domain in domains[:3]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –ø–µ—Ä–≤—ã—Ö 3 –¥–æ–º–µ–Ω–æ–≤
        context += f"  - `qdrant-find(query=\"–≤–∞—à –∑–∞–ø—Ä–æ—Å\", collection_name=\"{domain}\")`\n"
    
    if len(domains) > 3:
        context += f"  - ... –∏ –¥—Ä—É–≥–∏–µ –¥–æ–º–µ–Ω—ã: {', '.join(domains[3:])}\n"
    
    context += "\n"
    
    return context

def detect_hallucination(response_text: str) -> bool:
    """–î–µ—Ç–µ–∫—Ü–∏—è –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π –≤ –æ—Ç–≤–µ—Ç–µ –∞–≥–µ–Ω—Ç–∞"""
    if not response_text:
        return True
    
    # –ü—Ä–∏–∑–Ω–∞–∫–∏ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π
    hallucination_indicators = [
        "<tool_call>",
        "tool_call",
        "mcp_qdrant",
        "qdrant-find(",
        "qdrant-store("
    ]
    
    response_lower = response_text.lower()
    for indicator in hallucination_indicators:
        if indicator.lower() in response_lower:
            return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    if len(response_text.strip()) < 50:
        return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
    if any(tech_word in response_lower for tech_word in ["error", "–æ—à–∏–±–∫–∞", "exception", "traceback"]):
        if not any(good_word in response_lower for good_word in ["–æ—Ç–≤–µ—Ç", "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–¥–∞–Ω–Ω—ã–µ", "—Ä–µ–∑—É–ª—å—Ç–∞—Ç", "–Ω–∞–π–¥–µ–Ω–æ"]):
            return True
    
    return False

# Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
class ChatRequest(BaseModel):
    query: str

class StreamRequest(BaseModel):
    query: str

class ChatWithRetryRequest(BaseModel):
    query: str
    temperature: float = 0.1


async def create_agent():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ MCP –∞–≥–µ–Ω—Ç–∞"""
    global _agent_cache
    
    if _agent_cache is not None:
        return _agent_cache
    
    try:
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Qdrant Domains MCP —Å–µ—Ä–≤–µ—Ä–∞
        config = {
            "mcpServers": {
                "qdrant-domains": {
                    "url": MCP_QDRANT_SSE_URL
                }
            }
        }
        
        client = MCPClient.from_dict(config)
        
        llm = ChatOpenAI(
            model="Qwen/Qwen3-Coder-30B-A3B-Instruct",
            base_url=os.environ["OPENAI_BASE_URL"],
            api_key="dummy-key",
            temperature=0.3,
            max_tokens=2000
        )
    
        # –°–æ–∑–¥–∞–µ–º –∞–≥–µ–Ω—Ç–∞ —Å MCP –∫–ª–∏–µ–Ω—Ç–æ–º
        agent = MCPAgent(
            llm=llm,
            client=client,
            max_steps=2,
            verbose=True,  # –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥
            memory_enabled=True  # –í–∫–ª—é—á–∞–µ–º –ø–∞–º—è—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        )
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≥–µ–Ω—Ç–∞
        #await agent.initialize()
        
        print("‚úÖ Qdrant Domains MCP Agent –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        return agent
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≥–µ–Ω—Ç–∞: {e}")
        raise e


@app.post("/stream")
async def stream_agent_response(request: StreamRequest):
    """Stream agent response using Server-Sent Events"""
    
    async def event_generator():
        try:
            system_prompt = """
# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–∞ —Å Qdrant Domains

## –†–æ–ª—å –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–í—ã - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Ä–∞–±–æ—Ç–∞—é—â–∏–π —Å –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö Qdrant Domains. –í–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ - –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ—á–Ω—ã–µ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Ö—Ä–∞–Ω—è—â–µ–π—Å—è –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–æ–º–µ–Ω–æ–≤.

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ–∏—Å–∫–∞
–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º:

### `qdrant-find`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–æ–º–µ–Ω–∞–º
- **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ª—é–±–æ–º—É –∑–∞–ø—Ä–æ—Å—É
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**: 
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –¥–æ–º–µ–Ω–∞–º
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  - –ú–æ–∂–µ—Ç –∏—Å–∫–∞—Ç—å –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º, —Ñ—Ä–∞–∑–∞–º –∏–ª–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è–º
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –∫–æ–ª–ª–µ–∫—Ü–∏—è–º –¥–æ–º–µ–Ω–æ–≤

### `qdrant-store`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–∏—Å–∫–∞
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

## –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã

### 1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –§–æ—Ä–º–∞—Ç –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤**
- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–õ–¨–ö–û JSON-—Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ XML-–ø–æ–¥–æ–±–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Ç–∏–ø–∞ `<function=name> <parameter=key>value</parameter> </function>`
- –ü–†–ê–í–ò–õ–¨–ù–´–ô —Ñ–æ—Ä–º–∞—Ç: –≤—ã–∑—ã–≤–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏–∏ —Å JSON-–∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
- –ü—Ä–∏–º–µ—Ä –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –≤—ã–∑–æ–≤–∞: `qdrant-find(query="–≤–∞—à –∑–∞–ø—Ä–æ—Å", collection_name="–∏–º—è_–∫–æ–ª–ª–µ–∫—Ü–∏–∏")`
- –ü—Ä–∏–º–µ—Ä –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ì–û: `<function=qdrant-find> <parameter=query>–≤–∞—à –∑–∞–ø—Ä–æ—Å</parameter> </function>`

### 2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ–∏—Å–∫–∞
- **–í–°–ï–ì–î–ê** –Ω–∞—á–∏–Ω–∞–π—Ç–µ —Å –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `qdrant-find` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –æ—á–µ–≤–∏–¥–µ–Ω
- –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∏—Å–∫ –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö –¥–æ–º–µ–Ω–æ–≤

### 3. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–∏—Å–∫–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã
- –†–∞–∑–±–∏–≤–∞–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ö–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–æ–±—É–π—Ç–µ —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ –¥–æ–º–µ–Ω–æ–≤

### 4. –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤
- –û—Ç–≤–µ—á–∞–π—Ç–µ –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á–µ—Å—Ç–Ω–æ —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–º
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π—Ç–µ –∏ –Ω–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –±–∞–∑–µ
- –¶–∏—Ç–∏—Ä—É–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–†–ê–í–ò–õ–¨–ù–´–ô —Ñ–æ—Ä–º–∞—Ç –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - JSON-—Ñ–æ—Ä–º–∞—Ç:**
```
qdrant-find(query="—Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏", collection_name="cliring")
```

**‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - XML-—Ñ–æ—Ä–º–∞—Ç:**
```
<function=qdrant-find> <parameter=query>—Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</parameter> </function>
```

### –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏?"
–î–µ–π—Å—Ç–≤–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ qdrant-find —Å –∑–∞–ø—Ä–æ—Å–æ–º "—Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" –∏ collection_name="cliring"
```

### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫–∏–µ –µ—Å—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º–∏ —Å—á–µ—Ç–∞–º–∏?"
–î–µ–π—Å—Ç–≤–∏–µ: 
1. qdrant-find(query="–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å—á–µ—Ç–∞", collection_name="cliring")
2. qdrant-find(query="–º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å—á–µ—Ç–∞–º–∏", collection_name="cliring")
3. qdrant-find(query="—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏", collection_name="cliring")
```

### –ü–æ–∏—Å–∫ –≤ —Ä–∞–∑–Ω—ã—Ö –¥–æ–º–µ–Ω–∞—Ö
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö"
–î–µ–π—Å—Ç–≤–∏–µ: 
1. qdrant-find(query="–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", collection_name="cliring")
2. qdrant-find(query="–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", collection_name="other_domain")
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π
- –ù–ï –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∫–æ–ª–ª–µ–∫—Ü–∏—é)

## –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤
1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (—É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é)
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
3. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
4. –£–∫–∞–∂–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏—é

## –°–æ–≤–µ—Ç—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É –ø–æ–∏—Å–∫—É
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
- –ü—Ä–æ–±—É–π—Ç–µ –∫–∞–∫ –æ–±—â–∏–µ, —Ç–∞–∫ –∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã
- –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–µ–ª–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ –¥–æ–º–µ–Ω–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ qdrant-store –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–ü–æ–º–Ω–∏—Ç–µ: –≤–∞—à–∞ —Ü–µ–Ω–Ω–æ—Å—Ç—å –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ—á–Ω–æ–º –ø–æ–∏—Å–∫–µ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–æ–º–µ–Ω–æ–≤, –∞ –Ω–µ –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π.
–û–ë–†–ê–¢–ò –í–ù–ò–ú–ê–ù–ò–ï –ù–ê –§–û–†–ú–ê–¢ –í–´–ó–û–í–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í - –û–ù –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –û–ß–ï–ù–¨ –¢–û–ß–ù–´–ú.
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï
–¢—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–æ–∂–µ—à—å –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å –Ω–∞ step 1 - –∑–Ω–∞—á–∏—Ç —Ç—ã –Ω–µ–≤–µ—Ä–Ω–æ –≤—ã–∑–≤–∞–ª tool
"""
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–º–µ–Ω–∞—Ö
            domains_context = build_domains_context()
            system_prompt += domains_context
            #qdrant_query = f"""–ü—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã qdrant-domains –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –ø–æ–∏—Å–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–æ–º–µ–Ω–æ–≤, –≤ –∫–æ—Ç–æ—Ä–æ–π —Å–æ–¥–µ—Ä–∂–∞—Ç—Å—è –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (qdrant-find –∏ qdrant-store) –¥–ª—è –ø–æ–∏—Å–∫–∞ —á—Ç–æ–±—ã –¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å: {request.query}"""
            # –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ–º–µ–Ω—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∑–∞–ø—Ä–æ—Å–µ
            available_domains = load_available_domains()
            
            if available_domains:
                domains_list = ", ".join(available_domains)
                examples = "\n".join([f"- qdrant-find(query=\"–≤–∞—à –∑–∞–ø—Ä–æ—Å\", collection_name=\"{domain}\")" for domain in available_domains[:3]])
                if len(available_domains) > 3:
                    examples += f"\n- ... –∏ –¥—Ä—É–≥–∏–µ –¥–æ–º–µ–Ω—ã: {', '.join(available_domains[3:])}"
            else:
                domains_list = "–¥–æ–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
                examples = "- qdrant-find(query=\"–≤–∞—à –∑–∞–ø—Ä–æ—Å\", collection_name=\"default\")"
            
            qdrant_query = f"""–ò–°–ü–û–õ–¨–ó–£–ô–¢–ï –¢–û–õ–¨–ö–û JSON-—Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. 
–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ–º–µ–Ω—ã: {domains_list}
–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤:
{examples}

–û—Ç–≤–µ—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å: {request.query}"""
            #graphrag_query = f"""–£ —Ç–µ–±—è –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–û–î–£–ú–ê–ô –ò –ü–†–û–í–ï–†–¨ –§–û–†–ú–ê–¢ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ - –≤—ã–∑—ã–≤–∞–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ç–∞–∫ `mcp_qdrant_qdrant-find(query="–≤–∞—à –∑–∞–ø—Ä–æ—Å")`. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã qdrant –ø–æ–∑–≤–∞–ª—è—é—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –ø–æ–∏—Å–∫ –≤ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –≤ –∫–æ—Ç–æ—Ä–æ–π —Å–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞, —á—Ç–æ–±—ã –¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å: {request.query}"""

            # –ú–∞—Å—Å–∏–≤ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
            temperature_values = [0.2, 1, 2, 3, 4]
            max_attempts = len(temperature_values)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
            yield f"data: {json.dumps({'type': 'start', 'message': '–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫...', 'query': request.query, 'max_attempts': max_attempts, 'timestamp': time.time()})}\n\n"
            
            import mcp_use
            config = {
                "mcpServers": {
                    "qdrant-domains": {
                        "url": MCP_QDRANT_SSE_URL
                    }
                }
            }
            client = MCPClient.from_dict(config)
           
            await client.create_all_sessions()
            session = client.get_session("qdrant-domains")
                
            if session:
                tools = await session.list_tools()
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö
                yield f"data: {json.dumps({'type': 'tools_info', 'message': f'–ù–∞–π–¥–µ–Ω–æ {len(tools)} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤', 'tools': [{'name': tool.name, 'description': tool.description} for tool in tools], 'timestamp': time.time()})}\n\n"
            
            # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–º–∏
            final_result = None
            for attempt in range(max_attempts):
                temperature = temperature_values[attempt]
                
                yield f"data: {json.dumps({'type': 'attempt_start', 'message': f'–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_attempts} —Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π {temperature}', 'attempt': attempt + 1, 'temperature': temperature, 'timestamp': time.time()})}\n\n"
                
                # –°–æ–∑–¥–∞–µ–º LLM —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è Qwen3-Coder
                llm = ChatOpenAI(
                    model="Qwen/Qwen3-Coder-30B-A3B-Instruct",
                    base_url=os.environ["OPENAI_BASE_URL"],
                    api_key="dummy-key",
                    temperature=temperature,
                    max_tokens=2000
                )
            
                # –°–æ–∑–¥–∞–µ–º –∞–≥–µ–Ω—Ç–∞ —Å MCP –∫–ª–∏–µ–Ω—Ç–æ–º
                agent = MCPAgent(
                    llm=llm,
                    client=client,
                    max_steps=20,
                    verbose=True,
                    memory_enabled=False,
                    additional_instructions=system_prompt
                )
                                            
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º stream –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
                tool_results = []  # –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
                
                async for item in agent.stream(qdrant_query):
                    if isinstance(item, str):
                        # Final result
                        final_result = item
                        is_hallucination = detect_hallucination(final_result)
                        print(f"üîß –ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è: {is_hallucination}")
                        if is_hallucination == True:
                            #final_result = None
                            break
                        else:
                            yield f"data: {json.dumps({'type': 'final_result', 'message': f'–ü–æ–ª—É—á–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}', 'content': item, 'attempt': attempt + 1, 'temperature': temperature, 'timestamp': time.time()})}\n\n"
                            break  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                    else:
                        # Intermediate step (action, observation)
                        action, observation = item
                        print(f'–í—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: {action.tool}')
                        yield f"data: {json.dumps({'type': 'tool_call', 'message': f'–í—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: {action.tool}', 'tool': action.tool, 'tool_input': str(action.tool_input) if hasattr(action, 'tool_input') else None, 'attempt': attempt + 1, 'timestamp': time.time()})}\n\n"
                        
                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                        tool_results.append({
                            'tool': action.tool,
                            'observation': observation,
                            'tool_input': str(action.tool_input) if hasattr(action, 'tool_input') else None
                        })
                        
                        # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                        if len(tool_results) > 5:
                            tool_results = tool_results[-5:]
                        
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                        yield f"data: {json.dumps({'type': 'tool_result', 'message': '–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞', 'observation': observation[:500] + ('...' if len(observation) > 500 else ''), 'attempt': attempt + 1, 'timestamp': time.time()})}\n\n"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏
                if final_result:                    
                    hallucination_status = "–î–∞" if is_hallucination else "–ù–µ—Ç"
                    yield f"data: {json.dumps({'type': 'hallucination_check', 'message': f'–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏: {hallucination_status}', 'is_hallucination': is_hallucination, 'attempt': attempt + 1, 'timestamp': time.time()})}\n\n"
                    
                    if not is_hallucination:
                        # –£—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–µ–∑ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π
                        yield f"data: {json.dumps({'type': 'success', 'message': f'–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}', 'attempt': attempt + 1, 'temperature': temperature, 'timestamp': time.time()})}\n\n"
                        break  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ –ø–æ–ø—ã—Ç–æ–∫
                    else:
                        # –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è
                        yield f"data: {json.dumps({'type': 'hallucination_detected', 'message': f'–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}', 'attempt': attempt + 1, 'temperature': temperature, 'timestamp': time.time()})}\n\n"
                        
                        if attempt < max_attempts - 1:
                            yield f"data: {json.dumps({'type': 'retry', 'message': f'–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–ø—ã—Ç–∫–µ {attempt + 2} —Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π {temperature_values[attempt + 1]}', 'next_temperature': temperature_values[attempt + 1], 'timestamp': time.time()})}\n\n"
                        else:
                            yield f"data: {json.dumps({'type': 'all_attempts_failed', 'message': '–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç', 'timestamp': time.time()})}\n\n"
                else:
                    # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
                    yield f"data: {json.dumps({'type': 'forced_generation', 'message': f'–ê–≥–µ–Ω—Ç –Ω–µ –¥–∞–ª —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç...', 'attempt': attempt + 1, 'timestamp': time.time()})}\n\n"
                    
                    if tool_results:
                        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
                        context_parts = []
                        for i, result in enumerate(tool_results, 1):
                            context_parts.append(f"–†–µ–∑—É–ª—å—Ç–∞—Ç {i} ({result['tool']}):\n{result['observation']}\n")
                        
                        context = "\n".join(context_parts)
                        
                        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
                        forced_prompt = f"""–ù–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Qdrant Domains, –¥–∞–π –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {request.query}

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:
{context}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:
1. –î–∞–π –ø–æ–ª–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
2. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á–µ—Å—Ç–Ω–æ –æ–± —ç—Ç–æ–º —Å–æ–æ–±—â–∏
3. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
4. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –ª–æ–≥–∏—á–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ
5. –£–∫–∞–∂–∏, —á—Ç–æ –æ—Ç–≤–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Qdrant Domains

–û—Ç–≤–µ—Ç:"""

                        try:
                            # –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
                            forced_llm = ChatOpenAI(
                                model="Qwen/Qwen3-Coder-30B-A3B-Instruct",
                                base_url=os.environ["OPENAI_BASE_URL"],
                                api_key="dummy-key",
                                temperature=0.2,
                                max_tokens=2000
                            )
                            
                            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
                            response = await forced_llm.ainvoke(forced_prompt)
                            final_result = response.content if hasattr(response, 'content') else str(response)
                            
                            yield f"data: {json.dumps({'type': 'forced_result', 'message': '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞', 'content': final_result, 'attempt': attempt + 1, 'timestamp': time.time()})}\n\n"
                            
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏
                            is_hallucination = detect_hallucination(final_result)
                            
                            if not is_hallucination:
                                yield f"data: {json.dumps({'type': 'final_result', 'message': f'–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–µ–Ω –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}', 'attempt': attempt + 1, 'temperature': temperature, 'timestamp': time.time()})}\n\n"
                                break  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ –ø–æ–ø—ã—Ç–æ–∫
                            else:
                                yield f"data: {json.dumps({'type': 'forced_hallucination', 'message': f'–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}', 'attempt': attempt + 1, 'timestamp': time.time()})}\n\n"
                                
                        except Exception as forced_error:
                            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {forced_error}")
                            # Fallback –æ—Ç–≤–µ—Ç
                            fallback_response = f"""–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Qdrant Domains –ø–æ –∑–∞–ø—Ä–æ—Å—É "{request.query}":

{context[:1000]}...

–í—ã–ø–æ–ª–Ω–µ–Ω–æ {len(tool_results)} –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç.

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
3. –†–∞–∑–±–µ–π—Ç–µ —Å–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å –Ω–∞ —á–∞—Å—Ç–∏

–ù–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Qdrant Domains."""
                            
                            final_result = fallback_response
                            yield f"data: {json.dumps({'type': 'fallback_result', 'message': 'Fallback –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞', 'content': final_result, 'attempt': attempt + 1, 'timestamp': time.time()})}\n\n"
                            break  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ –ø–æ–ø—ã—Ç–æ–∫
                    else:
                        # –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                        no_results_response = f"""–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Qdrant Domains –ø–æ –∑–∞–ø—Ä–æ—Å—É "{request.query}".

–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –û—à–∏–±–∫–∏ –≤ —Ä–∞–±–æ—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."""
                        
                        final_result = no_results_response
                        yield f"data: {json.dumps({'type': 'no_results', 'message': '–û—Ç–≤–µ—Ç –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞', 'content': final_result, 'attempt': attempt + 1, 'timestamp': time.time()})}\n\n"
                        break  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ –ø–æ–ø—ã—Ç–æ–∫
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–≤–µ—Ä—à–∞—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ
            yield f"data: {json.dumps({'type': 'complete', 'message': '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'final_result': final_result, 'timestamp': time.time()})}\n\n"
            yield "data: [DONE]\n\n"
            
        except Exception as e:
            error_data = {"type": "error", "message": f"–û—à–∏–±–∫–∞: {str(e)}", "timestamp": time.time()}
            yield f"data: {json.dumps(error_data)}\n\n"
            yield "data: [DONE]\n\n"
    
    return StreamingResponse(
        event_generator(),
        media_type="text/plain",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "Access-Control-Allow-Origin": "*"
        }
    )


@app.post("/chat")
async def chat_response(request: ChatRequest, temperature: float = 0.3):
    """Chat endpoint —Å –ª–æ–≥–∏–∫–æ–π –∫–∞–∫ —É /stream: —Ä–µ—Ç—Ä–∞–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è"""
    try:
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –≤ /stream
        system_prompt = """
# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–∞ —Å Qdrant Domains

## –†–æ–ª—å –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–í—ã - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Ä–∞–±–æ—Ç–∞—é—â–∏–π —Å –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö Qdrant Domains. –í–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ - –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ—á–Ω—ã–µ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Ö—Ä–∞–Ω—è—â–µ–π—Å—è –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–æ–º–µ–Ω–æ–≤.

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ–∏—Å–∫–∞
–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º:

### `qdrant-find`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–æ–º–µ–Ω–∞–º
- **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ª—é–±–æ–º—É –∑–∞–ø—Ä–æ—Å—É
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**: 
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –¥–æ–º–µ–Ω–∞–º
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  - –ú–æ–∂–µ—Ç –∏—Å–∫–∞—Ç—å –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º, —Ñ—Ä–∞–∑–∞–º –∏–ª–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è–º
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –∫–æ–ª–ª–µ–∫—Ü–∏—è–º –¥–æ–º–µ–Ω–æ–≤

### `qdrant-store`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–∏—Å–∫–∞
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
  - –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

## –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã

### 1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –§–æ—Ä–º–∞—Ç –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤**
- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–õ–¨–ö–û JSON-—Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ XML-–ø–æ–¥–æ–±–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Ç–∏–ø–∞ `<function=name> <parameter=key>value</parameter> </function>`
- –ü–†–ê–í–ò–õ–¨–ù–´–ô —Ñ–æ—Ä–º–∞—Ç: –≤—ã–∑—ã–≤–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏–∏ —Å JSON-–∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
- –ü—Ä–∏–º–µ—Ä –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –≤—ã–∑–æ–≤–∞: `qdrant-find(query="–≤–∞—à –∑–∞–ø—Ä–æ—Å", collection_name="–∏–º—è_–∫–æ–ª–ª–µ–∫—Ü–∏–∏")`
- –ü—Ä–∏–º–µ—Ä –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ì–û: `<function=qdrant-find> <parameter=query>–≤–∞—à –∑–∞–ø—Ä–æ—Å</parameter> </function>`

### 2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ–∏—Å–∫–∞
- **–í–°–ï–ì–î–ê** –Ω–∞—á–∏–Ω–∞–π—Ç–µ —Å –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `qdrant-find` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –æ—á–µ–≤–∏–¥–µ–Ω
- –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∏—Å–∫ –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö –¥–æ–º–µ–Ω–æ–≤

### 3. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–∏—Å–∫–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã
- –†–∞–∑–±–∏–≤–∞–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ö–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–æ–±—É–π—Ç–µ —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ –¥–æ–º–µ–Ω–æ–≤

### 4. –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤
- –û—Ç–≤–µ—á–∞–π—Ç–µ –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á–µ—Å—Ç–Ω–æ —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–º
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π—Ç–µ –∏ –Ω–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –±–∞–∑–µ
- –¶–∏—Ç–∏—Ä—É–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–†–ê–í–ò–õ–¨–ù–´–ô —Ñ–æ—Ä–º–∞—Ç –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - JSON-—Ñ–æ—Ä–º–∞—Ç:**
```
qdrant-find(query="—Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏", collection_name="cliring")
```

**‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - XML-—Ñ–æ—Ä–º–∞—Ç:**
```
<function=qdrant-find> <parameter=query>—Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</parameter> </function>
```

### –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏?"
–î–µ–π—Å—Ç–≤–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ qdrant-find —Å –∑–∞–ø—Ä–æ—Å–æ–º "—Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" –∏ collection_name="cliring"
```

### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫–∏–µ –µ—Å—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º–∏ —Å—á–µ—Ç–∞–º–∏?"
–î–µ–π—Å—Ç–≤–∏–µ: 
1. qdrant-find(query="–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å—á–µ—Ç–∞", collection_name="cliring")
2. qdrant-find(query="–º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å—á–µ—Ç–∞–º–∏", collection_name="cliring")
3. qdrant-find(query="—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏", collection_name="cliring")
```

### –ü–æ–∏—Å–∫ –≤ —Ä–∞–∑–Ω—ã—Ö –¥–æ–º–µ–Ω–∞—Ö
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö"
–î–µ–π—Å—Ç–≤–∏–µ: 
1. qdrant-find(query="–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", collection_name="cliring")
2. qdrant-find(query="–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", collection_name="other_domain")
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π
- –ù–ï –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∫–æ–ª–ª–µ–∫—Ü–∏—é)

## –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤
1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (—É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é)
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
3. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
4. –£–∫–∞–∂–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏—é

## –°–æ–≤–µ—Ç—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É –ø–æ–∏—Å–∫—É
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
- –ü—Ä–æ–±—É–π—Ç–µ –∫–∞–∫ –æ–±—â–∏–µ, —Ç–∞–∫ –∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã
- –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–µ–ª–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ –¥–æ–º–µ–Ω–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ qdrant-store –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–ü–æ–º–Ω–∏—Ç–µ: –≤–∞—à–∞ —Ü–µ–Ω–Ω–æ—Å—Ç—å –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ—á–Ω–æ–º –ø–æ–∏—Å–∫–µ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–æ–º–µ–Ω–æ–≤, –∞ –Ω–µ –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π.
–û–ë–†–ê–¢–ò –í–ù–ò–ú–ê–ù–ò–ï –ù–ê –§–û–†–ú–ê–¢ –í–´–ó–û–í–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í - –û–ù –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –û–ß–ï–ù–¨ –¢–û–ß–ù–´–ú.
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –Ω–∞ –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï
–¢—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–æ–∂–µ—à—å –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å –Ω–∞ step 1 - –∑–Ω–∞—á–∏—Ç —Ç—ã –Ω–µ–≤–µ—Ä–Ω–æ –≤—ã–∑–≤–∞–ª tool
"""
        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ–º–µ–Ω–æ–≤
        domains_context = build_domains_context()
        system_prompt += domains_context

        # –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ–º–µ–Ω—ã –∏ –ø—Ä–∏–º–µ—Ä—ã
        available_domains = load_available_domains()
        if available_domains:
            domains_list = ", ".join(available_domains)
            examples = "\n".join([f"- qdrant-find(query=\"–≤–∞—à –∑–∞–ø—Ä–æ—Å\", collection_name=\"{d}\")" for d in available_domains[:3]])
            if len(available_domains) > 3:
                examples += f"\n- ... –∏ –¥—Ä—É–≥–∏–µ –¥–æ–º–µ–Ω—ã: {', '.join(available_domains[3:])}"
        else:
            domains_list = "–¥–æ–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            examples = "- qdrant-find(query=\"–≤–∞—à –∑–∞–ø—Ä–æ—Å\", collection_name=\"default\")"

        qdrant_query = f"""–ò–°–ü–û–õ–¨–ó–£–ô–¢–ï –¢–û–õ–¨–ö–û JSON-—Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. 
–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ–º–µ–Ω—ã: {domains_list}
–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤:
{examples}

–û—Ç–≤–µ—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å: {request.query}"""

        # MCP –∫–ª–∏–µ–Ω—Ç –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        config = {
            "mcpServers": {
                "qdrant-domains": {"url": MCP_QDRANT_SSE_URL}
            }
        }
        client = MCPClient.from_dict(config)
        await client.create_all_sessions()
        session = client.get_session("qdrant-domains")
        if session:
            try:
                tools = await session.list_tools()
                print(f"üîß –ù–∞–π–¥–µ–Ω–æ {len(tools)} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è /chat")
            except Exception:
                pass

        # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∫–∞–∫ –≤ /stream
        temperature_values = [0.2, 1, 2, 3, 4]
        max_attempts = len(temperature_values)

        last_response_text = None
        last_tool_results = []

        for attempt in range(max_attempts):
            current_temp = temperature_values[attempt]
            print(f"üîß –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1} –∏–∑ {max_attempts}, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {current_temp}")
            # LLM –∏ –∞–≥–µ–Ω—Ç
            llm = ChatOpenAI(
                model="Qwen/Qwen3-Coder-30B-A3B-Instruct",
                base_url=os.environ["OPENAI_BASE_URL"],
                api_key="dummy-key",
                temperature=current_temp,
                max_tokens=2000
            )

            agent = MCPAgent(
                llm=llm,
                client=client,
                max_steps=20,
                verbose=True,
                memory_enabled=False,
                additional_instructions=system_prompt
            )

            tool_results = []
            final_result = None

            async for item in agent.stream(qdrant_query):
                if isinstance(item, str):
                    final_result = item
                    print(f"üîß –†–µ–∑—É–ª—å—Ç–∞—Ç: {final_result}")
                    is_hallucination = detect_hallucination(final_result)
                    print(f"üîß –ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è: {is_hallucination}")
                    if is_hallucination:
                        print(f"–ó–∞—à–ª–∏ –≤ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—é: {is_hallucination}")
                        last_response_text = final_result
                        last_tool_results = tool_results
                        final_result = None
                        break
                    else:
                        return {
                            "query": request.query,
                            "response": final_result,
                            "attempt": attempt + 1,
                            "total_attempts": max_attempts,
                            "temperature": current_temp,
                            "tool_calls_count": len(tool_results),
                            "hallucination_detected": False,
                            "timestamp": time.time()
                        }
                else:
                    action, observation = item
                    tool_results.append({
                        'tool': action.tool,
                        'observation': observation,
                        'tool_input': str(action.tool_input) if hasattr(action, 'tool_input') else None
                    })
                    if len(tool_results) > 5:
                        tool_results = tool_results[-5:]

            # –ï—Å–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ tool_results
            if not final_result:
                print(f"üîß –ù–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è: {tool_results}")
                print(f"üîß Tool results: {tool_results}")
                if len(tool_results) > 0:
                    context_parts = []
                    for i, result in enumerate(tool_results, 1):
                        context_parts.append(f"–†–µ–∑—É–ª—å—Ç–∞—Ç {i} ({result['tool']}):\n{result['observation']}\n")
                    context = "\n".join(context_parts)

                    forced_prompt = f"""–ù–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Qdrant Domains, –¥–∞–π –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {request.query}

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:
{context}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:
1. –î–∞–π –ø–æ–ª–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
2. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á–µ—Å—Ç–Ω–æ –æ–± —ç—Ç–æ–º —Å–æ–æ–±—â–∏
3. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
4. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –ª–æ–≥–∏—á–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ
5. –£–∫–∞–∂–∏, —á—Ç–æ –æ—Ç–≤–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Qdrant Domains

–û—Ç–≤–µ—Ç:"""

                    try:
                        forced_llm = ChatOpenAI(
                            model="Qwen/Qwen3-Coder-30B-A3B-Instruct",
                            base_url=os.environ["OPENAI_BASE_URL"],
                            api_key="dummy-key",
                            temperature=0.2,
                            max_tokens=2000
                        )
                        response = await forced_llm.ainvoke(forced_prompt)
                        forced_text = response.content if hasattr(response, 'content') else str(response)
                        is_hallucination = detect_hallucination(forced_text)
                        if not is_hallucination:
                            return {
                                "query": request.query,
                                "response": forced_text,
                                "attempt": attempt + 1,
                                "total_attempts": max_attempts,
                                "temperature": current_temp,
                                "tool_calls_count": len(tool_results),
                                "forced_generation": True,
                                "hallucination_detected": False,
                                "timestamp": time.time()
                            }
                        else:
                            last_response_text = forced_text
                            last_tool_results = tool_results
                    except Exception as forced_error:
                        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {forced_error}")
                        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–µ
                        last_response_text = last_response_text or ""
                        last_tool_results = tool_results or last_tool_results
                else:
                    # –°–æ–≤—Å–µ–º –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
                    continue
                    no_results_response = f"""–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Qdrant Domains –ø–æ –∑–∞–ø—Ä–æ—Å—É "{request.query}".

–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –û—à–∏–±–∫–∏ –≤ —Ä–∞–±–æ—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."""
                    return {
                        "query": request.query,
                        "response": no_results_response,
                        "attempt": attempt + 1,
                        "total_attempts": max_attempts,
                        "temperature": current_temp,
                        "tool_calls_count": 0,
                        "hallucination_detected": False,
                        "timestamp": time.time()
                    }

        # –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ –¥–∞–ª–∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        return {
            "query": request.query,
            "response": last_response_text or "–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ –¥–∞–ª–∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.",
            "attempt": max_attempts,
            "total_attempts": max_attempts,
            "temperature": temperature_values[-1],
            "tool_calls_count": len(last_tool_results),
            "hallucination_detected": True,
            "warning": "–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã, –æ—Ç–≤–µ—Ç –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏",
            "timestamp": time.time()
        }

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≤ chat endpoint: {e}")
        return {
            "query": request.query,
            "response": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}",
            "error": str(e),
            "timestamp": time.time()
        }

@app.get("/tools")
async def get_available_tools():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"""
    try:
        agent = await create_agent()
        client = agent.client
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        await client.create_all_sessions()
        session = client.get_session("qdrant-domains")
        
        if session:
            tools = await session.list_tools()
            return {
                "tools": [
                    {
                        "name": tool.name,
                        "description": tool.description,
                        "inputSchema": tool.inputSchema if hasattr(tool, 'inputSchema') else None
                    }
                    for tool in tools
                ],
                "count": len(tools),
                "timestamp": time.time()
            }
        else:
            return {"error": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é", "timestamp": time.time()}
            
    except Exception as e:
        return {"error": str(e), "timestamp": time.time()}


@app.get("/domains")
async def get_domains():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ –∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–π"""
    try:
        domains = load_available_domains()
        summaries = load_all_domain_summaries()
        
        domains_info = []
        for domain in domains:
            domain_info = {
                "name": domain,
                "summary": summaries.get(domain, ""),
                "has_summary": domain in summaries
            }
            domains_info.append(domain_info)
        
        return {
            "domains": domains_info,
            "count": len(domains),
            "uploads_path": UPLOADS_PATH,
            "summary_path": SUMMARY_PATH,
            "timestamp": time.time()
        }
    except Exception as e:
        return {
            "error": str(e),
            "timestamp": time.time()
        }

@app.get("/status")
async def get_status():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∞–≥–µ–Ω—Ç–∞"""
    try:
        agent = await create_agent()
        domains = load_available_domains()
        return {
            "status": "ok",
            "agent_initialized": True,
            "model": "Qwen/Qwen3-Coder-30B-A3B-Instruct",
            "api_url": "http://localhost:19000/v1",
            "mcp_server": "http://localhost:8007/sse",
            "available_domains": domains,
            "domains_count": len(domains),
            "timestamp": time.time()
        }
    except Exception as e:
        return {
            "status": "error",
            "error": str(e),
            "timestamp": time.time()
        }


@app.get("/")
async def root():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ API"""
    domains = load_available_domains()
    summaries = load_all_domain_summaries()
    
    return {
        "message": "Qdrant Domains MCP Streaming API",
        "version": "1.0.0",
        "endpoints": {
            "stream": "POST /stream - Streaming –æ—Ç–≤–µ—Ç—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–æ–º–µ–Ω–æ–≤",
            "chat": "POST /chat - –û–±—ã—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–æ–º–µ–Ω–æ–≤", 
            "chat-with-retry": "POST /chat-with-retry - –û—Ç–≤–µ—Ç—ã —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –ø—Ä–∏ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è—Ö",
            "tools": "GET /tools - –°–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤",
            "domains": "GET /domains - –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤",
            "status": "GET /status - –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞"
        },
        "model": "Qwen/Qwen3-Coder-30B-A3B-Instruct",
        "mcp_server": "http://localhost:8007/sse",
        "domains": {
            "available": domains,
            "count": len(domains),
            "with_summaries": len(summaries),
            "uploads_path": UPLOADS_PATH,
            "summary_path": SUMMARY_PATH
        },
        "timestamp": time.time()
    }


# –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ shutdown (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
import atexit

def cleanup():
    """–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏"""
    global _agent_cache
    if _agent_cache and hasattr(_agent_cache, 'client'):
        try:
            # –°–æ–∑–¥–∞–µ–º event loop –¥–ª—è cleanup
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            loop.run_until_complete(_agent_cache.client.close_all_sessions())
            loop.close()
            print("üßπ –†–µ—Å—É—Ä—Å—ã –æ—á–∏—â–µ–Ω—ã")
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ä–µ—Å—É—Ä—Å–æ–≤: {e}")

atexit.register(cleanup)


if __name__ == "__main__":
    import uvicorn
    print("üöÄ –ó–∞–ø—É—Å–∫ Qdrant Domains MCP Streaming API...")
    print("üì° –ú–æ–¥–µ–ª—å: Qwen/Qwen3-Coder-30B-A3B-Instruct")
    print("üîó MCP —Å–µ—Ä–≤–µ—Ä: http://localhost:8007/sse")
    print("üåê API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: http://0.0.0.0:8663")
    
    uvicorn.run(
        app, 
        host="0.0.0.0", 
        port=8663,
        log_level="info"
    )
